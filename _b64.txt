import { useState, useCallback } from 'react';
import { useTranslations } from 'next-intl';
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Math as Tex, MathText } from '@/components/ui/math';
import type { Exercise } from './data';
import { EXERCISES, isRightTriangle } from './data';

// --- Visual Identify Exercise ---

function VisualIdentifyExercise({
  ex,
  index,
  result,
  onResult,
}: {
  ex: Extract<Exercise, { type: 'visual-identify' }>;
  index: number;
  result: boolean | null;
  onResult: (correct: boolean) => void;
}) {
  const t = useTranslations('lesson.pythagoras.exercises');
  const [selected, setSelected] = useState<number | null>(null);

  const handleSelect = (idx: number) => {
    if (selected !== null) return;
    setSelected(idx);
    onResult(idx === ex.correctIndex);
  };

  const renderTriangle = (sides: [number, number, number], label: string, idx: number) => {
    const [a, b, c] = [...sides].sort((x, y) => x - y);
    const isRight = isRightTriangle(a, b, c);
    const scale = 12;

    // Simple right-angle-ish triangle for visual
    const w = b * scale;
    const h = a * scale;
    const viewW = Math.max(w + 40, 100);
    const viewH = Math.max(h + 50, 100);

    let borderColor = 'border-border hover:border-primary/30';
    if (selected !== null) {
      if (idx === ex.correctIndex) {
        borderColor = 'border-success/40 bg-success/5';
      } else if (idx === selected && idx !== ex.correctIndex) {
        borderColor = 'border-error/40 bg-error/5';
      } else {
        borderColor = 'border-border opacity-50';
      }
    }

    return (
      <button
        key={idx}
        onClick={() => handleSelect(idx)}
        disabled={selected !== null}
        className={cn(
          'rounded-lg p-3 border cursor-pointer transition-all duration-200 bg-surface',
          borderColor,
          selected !== null && 'cursor-default',
        )}
      >